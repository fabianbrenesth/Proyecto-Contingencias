---
title: "Proyecto contingencias II"
author: "Félix Madrigal Mora"
date: "2024-10-23"
output: html_document
---
# Definir función de fuerzas de transición
```{r}
library(readxl)
#parametros para los mu de hombres
Mortalidad.H <- read_excel("Mortalidad.xlsx", sheet = 1)
Recuperacion.H <- read_excel("Recuperacion.xlsx", sheet = 1)
Transicion.H <- read_excel("Transicion.xlsx", sheet = 1)

#parametro para los mu de mujeres
Mortalidad.M <- read_excel("Mortalidad.xlsx", sheet = 2)
Recuperacion.M <- read_excel("Recuperacion.xlsx", sheet = 2)
Transicion.M <- read_excel("Transicion.xlsx", sheet = 2)
```

```{r}
#vamos a guardar en listas los parametros para luego solo llamar la funcion
#recorremos desde la columna dos ya que la primera son los parametros y lo que queremos es recorrer las fuerzas de transicion
params.transicion.H <- lapply(2:ncol(Transicion.H), function(col) {
  list(
    A = as.numeric(Transicion.H[Transicion.H$Parametros == "A", col]),
    B = as.numeric(Transicion.H[Transicion.H$Parametros == "B", col]),
    c = as.numeric(Transicion.H[Transicion.H$Parametros == "c", col]),
    D = as.numeric(Transicion.H[Transicion.H$Parametros == "D", col]),
    K = as.numeric(Transicion.H[Transicion.H$Parametros == "K", col]),
    H = as.numeric(Transicion.H[Transicion.H$Parametros == "H", col]),
    alpha1 = as.numeric(Transicion.H[Transicion.H$Parametros == "a1", col]),
    alpha2 = as.numeric(Transicion.H[Transicion.H$Parametros == "a2", col]),
    alpha3 = as.numeric(Transicion.H[Transicion.H$Parametros == "a3", col]),
    alpha4 = as.numeric(Transicion.H[Transicion.H$Parametros == "a4", col]),
    alpha5 = as.numeric(Transicion.H[Transicion.H$Parametros == "a5", col]),
    alpha6 = as.numeric(Transicion.H[Transicion.H$Parametros == "a6", col])
  )
    #alpha = Transicion.H[Transicion.H$Parametros %in% c("a1", "a2", "a3", "a4", "a5", "a6"), col]
})
names(params.transicion.H) <- names(Transicion.H)[-1]

```

```{r}
params.recuperacion.H <- lapply(2:ncol(Recuperacion.H), function(col) {
  list(
    beta1 = as.numeric(Recuperacion.H[Recuperacion.H$Parametros == "B1", col]),
    beta2 = as.numeric(Recuperacion.H[Recuperacion.H$Parametros == "B2", col]),
    beta3 = as.numeric(Recuperacion.H[Recuperacion.H$Parametros == "B3", col]
  ))
})
names(params.recuperacion.H) <- names(Recuperacion.H)[-1]
```

```{r}
params.mortalidad.H <- lapply(2:ncol(Mortalidad.H), function(col) {
  list(
    gamma1 = as.numeric(Mortalidad.H[Mortalidad.H$Parametros == "y1", col]),
    gamma2 = as.numeric(Mortalidad.H[Mortalidad.H$Parametros == "y2", col]),
    gamma3 = as.numeric(Mortalidad.H[Mortalidad.H$Parametros == "y3", col]),
    gamma4 = as.numeric(Mortalidad.H[Mortalidad.H$Parametros == "y4", col])
  )
})
names(params.mortalidad.H) <- names(Mortalidad.H)[-1]
```

```{r}
params.transicion.M <- lapply(2:ncol(Transicion.M), function(col) {
  list(
    A = as.numeric(Transicion.M[Transicion.M$Parametros == "A", col]),
    B = as.numeric(Transicion.M[Transicion.M$Parametros == "B", col]),
    c = as.numeric(Transicion.M[Transicion.M$Parametros == "c", col]),
    D = as.numeric(Transicion.M[Transicion.M$Parametros == "D", col]),
    K = as.numeric(Transicion.M[Transicion.M$Parametros == "K", col]),
    H = as.numeric(Transicion.M[Transicion.M$Parametros == "H", col]),
    alpha1 = as.numeric(Transicion.M[Transicion.M$Parametros == "a1", col]),
    alpha2 = as.numeric(Transicion.M[Transicion.M$Parametros == "a2", col]),
    alpha3 = as.numeric(Transicion.M[Transicion.M$Parametros == "a3", col]),
    alpha4 = as.numeric(Transicion.M[Transicion.M$Parametros == "a4", col]),
    alpha5 = as.numeric(Transicion.M[Transicion.M$Parametros == "a5", col]),
    alpha6 = as.numeric(Transicion.M[Transicion.M$Parametros == "a6", col])
  )
})
names(params.transicion.M) <- names(Transicion.M)[-1]
```

```{r}
params.recuperacion.M <- lapply(2:ncol(Recuperacion.M), function(col) {
  list(
    beta1 = as.numeric(Recuperacion.M[Recuperacion.M$Parametros == "B1", col]),
    beta2 = as.numeric(Recuperacion.M[Recuperacion.M$Parametros == "B2", col]),
    beta3 = as.numeric(Recuperacion.M[Recuperacion.M$Parametros == "B3", col]
  ))
})
names(params.recuperacion.M) <- names(Recuperacion.M)[-1]
```

```{r}
params.mortalidad.M <- lapply(2:ncol(Mortalidad.M), function(col) {
  list(
    gamma1 = as.numeric(Mortalidad.M[Mortalidad.M$Parametros == "y1", col]),
    gamma2 = as.numeric(Mortalidad.M[Mortalidad.M$Parametros == "y2", col]),
    gamma3 = as.numeric(Mortalidad.M[Mortalidad.M$Parametros == "y3", col]),
    gamma4 = as.numeric(Mortalidad.M[Mortalidad.M$Parametros == "y4", col])
  )
})
names(params.mortalidad.M) <- names(Mortalidad.M)[-1]

```


```{r}
U.H <- function(i, j, x) {
  
  nombre.col <- paste0("u", i, j)
  
  if (j == 6) {
    
    params <- params.mortalidad.H[[nombre.col]]
    
    
    mu <- params$gamma1+ params$gamma2 *x + exp(params$gamma3 + params$gamma4 * x)
    
    
  } else if (j < i) {
    
    if (abs(i - j) >= 2 || i == 6) {
      
      mu <- 0
      
    } else {
      
      params <- params.recuperacion.H[[nombre.col]]
      
      mu <- (params$beta1 + exp(params$beta2+ params$beta3*x)) / 
            (1 + params$beta1+ exp(params$beta2 +params$beta3* x))
      
    }
    
  } else if (i < j) {
    
    params <- params.transicion.H[[nombre.col]]
    
    blend_point <- as.numeric(Transicion.H[Transicion.H$Parametros == "Blend Point", nombre.col])
    
    if (x <= blend_point) {
      
      mu <- (params$A + params$B*(params$c^x)) / (1 + params$D * (params$c^x) + params$K * (params$c^-x)) + params$H
      
    } else {
      
      
      mu <- params$alpha1 * (x - blend_point)^5 +params$alpha2* (x - blend_point)^4 + params$alpha3 * (x - blend_point)^3 +
            params$alpha4 * (x - blend_point)^2+ params$alpha5 * (x - blend_point)+ params$alpha6
      
    }
  } 
  
  if (is.data.frame(mu)) {
    mu<-as.numeric(mu[[1]])
  }
  
  if (mu < 0){
    mu <- 0
  }
  return(mu) 
}
```

```{r}
U.M <- function(i, j, x) {
  
  nombre.col <- paste0("u", i, j)
  
  if (j == 6) {
    
    params <- params.mortalidad.M[[nombre.col]]
    
    mu <- params$gamma1 + params$gamma2 * x + exp(params$gamma3 + params$gamma4 * x)
    
    
  } else if (j < i) {
    
    if (abs(i - j) >= 2 || i == 6) {
      
      mu <- 0
      
    } else {
      
      params <- params.recuperacion.M[[nombre.col]]
      
      mu <- (params$beta1 + exp(params$beta2+ params$beta3*x)) / 
            (1 + params$beta1+ exp(params$beta2 +params$beta3* x))
      
    }
    
  } else if (i < j) {
    
    params <- params.transicion.M[[nombre.col]]
    
    blend_point <- as.numeric(Transicion.M[Transicion.M$Parametros == "Blend Point", nombre.col])
    
    if (x <= blend_point) {
      
      mu <- (params$A + params$B*(params$c^x)) / (1 + params$D * (params$c^x) + params$K * (params$c^-x)) + params$H
      
    } else {
      
      
      mu <- params$alpha1 * (x - blend_point)^5 +params$alpha2* (x - blend_point)^4 + params$alpha3 * (x - blend_point)^3 +
            params$alpha4 * (x - blend_point)^2+ params$alpha5 * (x - blend_point)+ params$alpha6
      
    }
  } 
  
  if (is.data.frame(mu)) {
    mu<-as.numeric(mu[[1]])
  }
  
  if (mu < 0){
    mu <- 0
  }
  return(mu)
}
```

# Constuir matrices de transición resolviendo forward-kolmogorov
```{r}
U.H_matrix <- function(x) {
  matrix(c(
    -(U.H(1, 2, x) + U.H(1, 3, x) + U.H(1, 4, x) + U.H(1, 5, x) + U.H(1, 6, x)), # Diagonal 1
    U.H(1, 2, x), U.H(1, 3, x), U.H(1, 4, x), U.H(1, 5, x), U.H(1, 6, x),
    
    U.H(2, 1, x),
    -(U.H(2, 1, x) + U.H(2, 3, x) + U.H(2, 4, x) + U.H(2, 5, x) + U.H(2, 6, x)), # Diagonal 2
    U.H(2, 3, x), U.H(2, 4, x), U.H(2, 5, x), U.H(2, 6, x),
    
    U.H(3, 1, x), U.H(3, 2, x),
    -(U.H(3, 1, x) + U.H(3, 2, x) + U.H(3, 4, x) + U.H(3, 5, x) + U.H(3, 6, x)), # Diagonal 3
    U.H(3, 4, x), U.H(3, 5, x), U.H(3, 6, x),
    
    U.H(4, 1, x), U.H(4, 2, x), U.H(4, 3, x),
    -(U.H(4, 1, x) + U.H(4, 2, x) + U.H(4, 3, x) + U.H(4, 5, x) + U.H(4, 6, x)), # Diagonal 4
    U.H(4, 5, x), U.H(4, 6, x),
    
    U.H(5, 1, x), U.H(5, 2, x), U.H(5, 3, x), U.H(5, 4, x),
    -(U.H(5, 1, x) + U.H(5, 2, x) + U.H(5, 3, x) + U.H(5, 4, x) + U.H(5, 6, x)), # Diagonal 5
    U.H(5, 6, x),
    
    U.H(6, 1, x), U.H(6, 2, x), U.H(6, 3, x), U.H(6, 4, x), U.H(6, 5, x),
    -(U.H(6, 1, x) + U.H(6, 2, x) + U.H(6, 3, x) + U.H(6, 4, x) + U.H(6, 5, x)) # Diagonal 6
  ), nrow = 6, byrow = TRUE)
}
```

```{r}
U.M_matrix <- function(x) {
  matrix(c(
    -(U.M(1, 2, x) + U.M(1, 3, x) + U.M(1, 4, x) + U.M(1, 5, x) + U.M(1, 6, x)), # Diagonal 1
    U.M(1, 2, x), U.M(1, 3, x), U.M(1, 4, x), U.M(1, 5, x), U.M(1, 6, x),
    
    U.M(2, 1, x),
    -(U.M(2, 1, x) + U.M(2, 3, x) + U.M(2, 4, x) + U.M(2, 5, x) + U.M(2, 6, x)), # Diagonal 2
    U.M(2, 3, x), U.M(2, 4, x), U.M(2, 5, x), U.M(2, 6, x),
    
    U.M(3, 1, x), U.M(3, 2, x),
    -(U.M(3, 1, x) + U.M(3, 2, x) + U.M(3, 4, x) + U.M(3, 5, x) + U.M(3, 6, x)), # Diagonal 3
    U.M(3, 4, x), U.M(3, 5, x), U.M(3, 6, x),
    
    U.M(4, 1, x), U.M(4, 2, x), U.M(4, 3, x),
    -(U.M(4, 1, x) + U.M(4, 2, x) + U.M(4, 3, x) + U.M(4, 5, x) + U.M(4, 6, x)), # Diagonal 4
    U.M(4, 5, x), U.M(4, 6, x),
    
    U.M(5, 1, x), U.M(5, 2, x), U.M(5, 3, x), U.M(5, 4, x),
    -(U.M(5, 1, x) + U.M(5, 2, x) + U.M(5, 3, x) + U.M(5, 4, x) + U.M(5, 6, x)), # Diagonal 5
    U.M(5, 6, x),
    
    U.M(6, 1, x), U.M(6, 2, x), U.M(6, 3, x), U.M(6, 4, x), U.M(6, 5, x),
    -(U.M(6, 1, x) + U.M(6, 2, x) + U.M(6, 3, x) + U.M(6, 4, x) + U.M(6, 5, x)) # Diagonal 6
  ), nrow = 6, byrow = TRUE)
}
```


Ahí estamos construyendo la matriz: 
$$
\mathbf{U}(t, x) = \begin{pmatrix}
-\sum_{j \neq 1} u_{x+t}^{1j} & u_{x+t}^{12} & u_{x+t}^{13} & \cdots \\
u_{x+t}^{21} & -\sum_{j \neq 2} u_{x+t}^{2j} & u_{x+t}^{23} & \cdots \\
u_{x+t}^{31} & u_{x+t}^{32} & -\sum_{j \neq 3} u_{x+t}^{3j} & \cdots \\
\vdots & \vdots & \vdots & \ddots
\end{pmatrix}
$$
Para así hacer la multiplicación P(t,x)*U(t,x) y obtener las ecuaciones forward kolmogorov, donde P es la matriz de probabilidades de transición tP^(ij)_x.

Ahora, si asumimos que U no depende de t, es decir, que U es constante a lo largo del año de cada edad, tenemos la ecuación diferencial:
$$

\frac{dp(t, x)}{dt} = p(t) \cdot U(x)

$$
La solución de esta ecuación diferencial es conocida  se expresa como:

$$
P(t,x) = P(0) \cdot e^{U(x)t}
$$
donde:
-P(0) es el vector de probabilidades iniciales en el tiempo  t = 0 , o sea la matriz identidad.
- e^(U(x)* t representa la matriz exponencial de  U(X)*t , definida como:
$$
e^{Ut} = \sum_{n=0}^{\infty} \frac{(Ut)^n}{n!} = I + Ut + \frac{(Ut)^2}{2!} + \frac{(Ut)^3}{3!} + \cdots
$$
```{r}
library(expm) #importamos librería para la forma exponencial de la matriz

#Lista de matrices
matrices.m <- list()
matrices.h <- list()

for (i in 1:118){ 
    fuerzas.h <- U.H_matrix(i)
    fuerzas.m <- U.M_matrix(i)
    
    # Calcular la matriz de transición usando la exponencial de la matriz
    matrices.h[[i]] <- expm(fuerzas.h)
    matrices.m[[i]] <- expm(fuerzas.m)
    
    #Normalizar las matrices por errores numéricos
    matrices.h[[i]] <- t(apply(matrices.h[[i]], 1, function(x) x / sum(x)))
    matrices.m[[i]] <- t(apply(matrices.m[[i]], 1, function(x) x / sum(x)))
}

# A partir de 120 no se puede vivir más
matriz <- matrix(0, nrow = 6, ncol = 6)
matriz[, 6] <- 1

matrices.h[[119]] <- matriz
matrices.m[[119]] <- matriz
```

```{r}
# Lista de probabilidades
prob.h <- vector("list", 119)
prob.m <- vector("list", 119)

# Llenar las probabilidades 
for (i in 119:1){
  # Listas de años de supervivencia 
  prob.h[[i]] <- vector("list", 120 - i)
  prob.m[[i]] <- vector("list", 120 - i)
  for (t in 1:120-i){
    
    if(i+t == 120){
      #120 es edad máxima
      matriz <- matrix(0, nrow = 6, ncol = 6)
      matriz[, 6] <- 1
      prob.h[[i]][[t]] <- matriz
      prob.m[[i]][[t]] <- matriz
    } else if (t == 1){
      prob.h[[i]][[t]] <- matrices.h[[i]]
      prob.m[[i]][[t]] <- matrices.m[[i]]
    } else if(t > 1) {
      prob.h[[i]][[t]] <- prob.h[[i]][[t-1]] %*% prob.h[[i+t-1]][[1]]
      prob.m[[i]][[t]] <- prob.m[[i]][[t-1]] %*% prob.m[[i+t-1]][[1]]
    }
  }
}
```

# Cálculo de prima
```{r}
#Anualidades

#Como solo se vende a personas sanas, no se recibe el estado actual (siempre va a ser 1)
#Asimismo, se usa 120 como edad maxima del modelo
#interés corresponde a una lista con la tasa spot de cada año, lista de tamaño 102 (120-18 = 102)

anualidad <- function(edad, j, probabilidades, interes, inflacion, 
                      temporal = TRUE){
  
  aumento <- 1 + inflacion
  
  # Se asume que es prepagable y que se emite para estado  = 1 
  # El primer pago solo se hará si el estado destino también es 1
    if(j == 1)
      anualidad <- 1
    else{
      anualidad <- 0
    }
  
  if(temporal){
    n <- 65-edad-1 #-1 porque ya hicimos un pago arriba
  }
  else{
    n <- 120-edad-1
  }
  
  # Los siguientes pagos se inflan
    for (k in 1:n){
      if(n == 0 || n<0){ 
        break
      }
      #print(k)
      v <- 1/(1+interes[[k]])
      
      anualidad <- anualidad + (v^k * aumento^k * 
                                  probabilidades[[edad]][[k]][1,j])
    }
  return(anualidad)
}

#Seguros

#Como solo se vende a personas sanas, no se recibe el estado actual (siempre va a ser 1)
#Como solo se va a utilizar por muerte, tampoco se recibe el estado destino (siempre va a ser 6)
#Asimismo, se usa 120 como edad maxima del modelo
#interés corresponde a una lista con la tasa spot de cada año, lista de tamaño 102 (120-18 = 102)
seguro <- function(edad, probabilidades, interes, inflacion){
  
  v <- 1/(1+interes[[1]])
  aumento <- 1 + inflacion
  
  n <- 120-edad
  
  #Para k = 0, la única forma de que el seguro pague es que se pase a 6 en un año. 
  seguro <- (v * aumento * probabilidades[[edad]][[1]][[1,6]])
  
  #Ahora iteramos desde k = 1
  for(k in 1:(n-1)){ 
    if((n-1) == 0 || (n-1)<0){
      break
    }
    v <- 1/(1+interes[[k+1]])
    temp <- 0
    
    for(i in 1:5){
      
      temp <- temp + probabilidades[[edad]][[k]][1,i] *
                     probabilidades[[(edad + k)]][[1]][i,6]
    }
    
    seguro <- seguro + (v^(k+1) * aumento^(k+1) * temp)
  }
  
  return(seguro)
}

```


## Prima Neta

```{r}
# Sin Gastos
# Se propone un beneficio anual en caso de que el asegurado se encuentre en el
# estado 4 o 5 y un beneficio de muerte pagable al final del año de muerte 
# con primas anuales mientras el asegurado se encuentre en 1 o 2

prima.neta <- function(edad, probabilidades, interes, inflacion){
  estado4 <- 10850000*anualidad(edad, 4, probabilidades, interes, inflacion, FALSE)
  estado5 <- 16570000*anualidad(edad, 5, probabilidades, interes, inflacion, FALSE)
  estado6 <- 1000000*seguro(edad, probabilidades, interes, inflacion)
  pagos <- anualidad(edad, 1, probabilidades, interes, inflacion) +
           anualidad(edad, 2, probabilidades, interes, inflacion)
  prima <- (estado4 + estado5 + estado6)/pagos
  return(prima)
}
```

## Prima Bruta
```{r}
# Con Gastos
# Mismo modelo, de beneficios
# Gastos de terminación cuando muere el asegurado
# Gastos Iniciales (monto fijo)
# Gastos de renovación (porcentaje fijo de las primas)
prima.bruta <- function(edad, probabilidades, interes, inflacion){
  estado4 <- 10850000*anualidad(edad, 4, probabilidades, interes, inflacion, FALSE)
  estado5 <- 16570000*anualidad(edad, 5, probabilidades, interes, inflacion, FALSE)
  estado6 <- 1150000*seguro(edad, probabilidades, interes, inflacion)
  pagos <- anualidad(edad, 1, probabilidades, interes, inflacion) +
           anualidad(edad, 2, probabilidades, interes, inflacion)
  prima <- (estado4 + estado5 + estado6)/(0.9*pagos-0.05)
  return(prima)
}
```

Calculamos la prima correspondiente para mujeres y hombres de edades 18 a 64
```{r}

#Utilizamos las tasas spot y splines lineales para los años 4, 6, 8, 9 para generar la lista de tasas de interés:

interes <- c(0.04285,  # 1 años
             0.04880,  # 2 años
             0.05312,  # 3 años
             0.05312 + (0.05859-0.05312)/2,  # 4 años
             0.05859,  # 5 años 
             0.05859 + (0.06161-0.05859)/2,# 6 años
             0.06161,  # 7 años
             0.06161 + (0.06395 - 0.06161)/3, # 8 años 
             0.06161 + ((0.06395 - 0.06161)/3)*2, # 9 años
             0.06395) # 10 años

interes <- c(interes, rep(0.06395, 120)) #Asumimos curva constante a partir de 10 años

primas.hombres <- sapply(18:64, function(edad) prima.bruta(edad, prob.h, interes, 0.03))

primas.mujeres <- sapply(18:64, function(edad) prima.bruta(edad, prob.m, interes, 0.03))

```

# Modelo estocástico 

## Funciones auxiliares
```{r}
contar.1a6 <- function(fila) {
  fila.sin.na <- na.omit(fila)
  conteos <- tabulate(fila.sin.na, nbins = 6)
  indices <- lapply(1:6, function(x) which(fila.sin.na == x))
  return(list(conteos = conteos, indices = indices))
}
```

```{r}
contar.18.64 <- function(fila) {
  # Remover los NA
  fila.sin.na <- na.omit(fila)
  
  # Crear un vector que cuente los valores desde 18 hasta 65
  conteos <- tabulate(fila.sin.na - 17, nbins = 64 - 18 + 1)
  
  # Retornar los conteos como un vector
  return(conteos)
}

```

## Funciones simulación
```{r}
simulacion.individual <- function(edad, prob){
  estados <- list() #Lista que guarda los estados en donde estuvo cada año
  estado.actual <- 1
  #simulamos 
  while (estado.actual != 6) {
    prob.transicion <- prob[[edad]][estado.actual,]
    
    particion1 <- prob.transicion[[1]]
    particion2 <- prob.transicion[[2]] + prob.transicion[[1]]
    particion3 <- prob.transicion[[3]] +prob.transicion[[2]] + 
      prob.transicion[[1]]
    particion4 <- prob.transicion[[4]] +prob.transicion[[3]] + 
      prob.transicion[[2]] + prob.transicion[[1]]
    particion5 <- prob.transicion[[5]] + prob.transicion[[4]]+   
      prob.transicion[[3]] + prob.transicion[[2]] + prob.transicion[[1]] 
   
    #valor aleatorio
    valor <- runif(1)
  
   # Vemos a donde transiciona
    if (valor < particion1) {
      estado.actual <- 1
    } else if (particion1 <= valor & valor < particion2) {
      estado.actual <- 2
    } else if (particion2 <= valor & valor < particion3) {
      estado.actual <- 3
    } else if (particion3 <= valor & valor < particion4) {
      estado.actual <- 4
    } else if (particion4 <= valor & valor < particion5) {
      estado.actual <- 5
    } else {
      estado.actual <- 6
    }
    
    estados[length(estados)+1] <- estado.actual
    edad <- edad + 1
  }
  
  return(estados)
}  

```

```{r}
simulacion.hombres <- function(hombres, primas.por.edad, suma.asegurada4, suma.asegurada5, suma.asegurada6){
  
  edades <- hombres$edades 

  #Matriz en donde cada año representa una fila y cada persona una columna
  matriz <- matrix(NA, nrow = 103, ncol = length(edades))
  
  for (i in 1:length(edades)){
    estados <- simulacion.individual(edades[[i]], matrices.h)
    matriz[1:length(estados), i] <- unlist(estados)
  }
  
  ingresos.por.estado <- matrix(0, nrow = 103, ncol = 6)
  egresos.por.estado <- matrix(0, nrow = 103, ncol = 6)
  cant.por.estado <- matrix(0, nrow = 103, ncol = 6)

  
  info.año.i <- contar.1a6(matriz[1,]) #Información sobre estados al final de año 1
  
  cant.por.estado[1,] <- info.año.i$conteos
  
  #Primer año de ingresos:
  #Todos pagan prima porque se emite para sanos
  contar.edades.principio <- contar.18.64(edades) #Contamos las edades al principio del seguro, esto devuelve una lista con la cantidad de asegurados por edad (primer índice representa 18 y así sucesivamente)
  
  ingresos.por.estado[1, 1] <- sum(contar.edades.principio*primas.por.edad)
  
  #Primer año de egresos: 
  #-Egreso por gasto inicial y gasto de primas
  egresos.por.estado[1,1] <- ingresos.por.estado[1, 1] *0.15

  #-Egreso por muerte 
  #ninguno: OBSERVACIÓN: como el egreso por muerte se paga al final del año, se va a considerar como un egreso del siguiente año, para facilitar la comparación de flujos. 
  
  #Iteramos sobre los finales de cada año. (Desde el final del año 2)
  for(i in 2:length(matriz[,1])){
    
    info.año.i.anterior <- info.año.i 
    info.año.i <- contar.1a6(matriz[i,])
    cant.por.estado[i,] <- info.año.i$conteos #Cantidad de personas en cada estado a final de año i 
    
    #Primero ajustamos la prima por inflación:
    primas.por.edad.ajustado <- primas.por.edad * ((1.03)^(i-1))
    
    #Ajustemos beneficios por inflación
    suma.asegurada4.ajustado <- suma.asegurada4 * ((1.03)^(i-1))
    suma.asegurada5.ajustado <- suma.asegurada5 * ((1.03)^(i-1))
    suma.asegurada6.ajustado <- suma.asegurada6 * ((1.03)^(i-1))
    
    #ESTADO 1
    #-Ingresos por primas:
    
    #Obtenemos edades de la gente en estado 1 al principio del año i (o sea al final de i-1)
    #Para esto obtenemos los índices de las personas que estaban en estado uno. Usamos esos índices para obtener su respectiva edad
    edades1.principio.año <- edades[info.año.i.anterior$indices[[1]]]
    
    contar.edades.principio <- contar.18.64(edades1.principio.año)
    
    #Esta gente paga prima, entonces los ingresos son la prima
    #Hay que considerar que solo pagan primas hasta 65 años (no incluido). 
    if((65-i-17) >= 1){
       ingresos.por.estado[i,1] <- 
      sum((contar.edades.principio * primas.por.edad.ajustado)[1:(65-i-17)])
       #-EGRESOS:
      egresos.por.estado[i,1] <- 0.10 *  ingresos.por.estado[i,1]
    }
    
    #ESTADO 2:
    #-Ingresos por primas:
    
    #Obtenemos edades de la gente en estado 2 al principio del año i (o sea al final de i-1)
    edades2.principio.año <- edades[info.año.i.anterior$indices[[2]]] 
    
    contar.edades.principio <- contar.18.64(edades2.principio.año)
    
    #Esta gente paga prima, entonces los ingresos son la prima
    #Hay que considerar que solo pagan primas hasta 65 años (no incluido). 
    if((65-i-17) >= 1){
       ingresos.por.estado[i,2] <- 
      sum((contar.edades.principio * primas.por.edad.ajustado)[1:(65-i-17)])
       
       #-EGRESOS:
      egresos.por.estado[i,2] <- 0.10 *  ingresos.por.estado[i,2]
    }
    
    #ESTADO 3
    #Esta gente no paga prima ni recibe beneficios entonces no hay ni ingresos ni egresos
    
    #ESTADO 4
    
    #No hay ingresos
    
    #-Egresos: 
    #No es necesario contar edades porque el egreso es el mismo para todos.
    egresos.por.estado[i,4] <- 
      info.año.i.anterior$conteos[4]*suma.asegurada4.ajustado
    
    #ESTADO 5
    
    #No hay ingresos
    
    #-Egresos: 
    #No es necesario contar edades porque el egreso es el mismo para todos.
    egresos.por.estado[i,5] <-  
      info.año.i.anterior$conteos[5]*suma.asegurada5.ajustado
    
    #ESTADO 6
    
    #No hay ingresos
    
    #-Egresos: 
    #Egresos de muertos del año pasado
    egresos.por.estado[i,6] <- 
      info.año.i.anterior$conteos[6]*suma.asegurada6.ajustado
    
    #si ya todos se murieron detenemos el ciclo for
    if(cant.por.estado[i,6] == length(edades)){
      break
    }
  }
  
  cant.por.estado[, 6] <- cumsum(cant.por.estado[, 6])
  ingresos <- as.list(rowSums(ingresos.por.estado))
  egresos <- as.list(rowSums(egresos.por.estado))
  
  return(list(estados = cant.por.estado, 
              ingresos = ingresos, 
              egresos = egresos,
              ingresos.estado = ingresos.por.estado,
              egresos.estado = egresos.por.estado)
         )
  
}


simulacion.mujeres <- function(mujeres, primas.por.edad, suma.asegurada4, suma.asegurada5, suma.asegurada6){
  
  edades <- mujeres$edades 

  #Matriz en donde cada año representa una fila y cada persona una columna
  matriz <- matrix(NA, nrow = 103, ncol = length(edades))
  
  for (i in 1:length(edades)){
    estados <- simulacion.individual(edades[[i]], matrices.m)
    matriz[1:length(estados), i] <- unlist(estados)
  }
  
  ingresos.por.estado <- matrix(0, nrow = 103, ncol = 6)
  egresos.por.estado <- matrix(0, nrow = 103, ncol = 6)
  cant.por.estado <- matrix(0, nrow = 103, ncol = 6)

  
  info.año.i <- contar.1a6(matriz[1,]) #Información sobre estados al final de año 1
  
  cant.por.estado[1,] <- info.año.i$conteos
  
  #Primer año de ingresos:
  #Todos pagan prima porque se emite para sanos
  contar.edades.principio <- contar.18.64(edades) #Contamos las edades al principio del seguro, esto devuelve una lista con la cantidad de asegurados por edad (primer índice representa 18 y así sucesivamente)
  
  ingresos.por.estado[1, 1] <- sum(contar.edades.principio*primas.por.edad)
  
  #Primer año de egresos: 
  #-Egreso por gasto inicial y gasto de primas
  egresos.por.estado[1,1] <- ingresos.por.estado[1, 1] * 0.15

  #-Egreso por muerte 
  #ninguno: OBSERVACIÓN: como el egreso por muerte se paga al final del año, se va a considerar como un egreso del siguiente año, para facilitar la comparación de flujos. 
  
  #Iteramos sobre los finales de cada año. (Desde el final del año 2)
  for(i in 2:length(matriz[,1])){
    
    info.año.i.anterior <- info.año.i 
    info.año.i <- contar.1a6(matriz[i,])
    cant.por.estado[i,] <- info.año.i$conteos #Cantidad de personas en cada estado a final de año i 
    
    #Primero ajustamos la prima por inflación:
    primas.por.edad.ajustado <- primas.por.edad * ((1.03)^(i-1))
    # i-1 porque las primas se pagan al principio de cada año
    
    #Ajustemos beneficios por inflación
    suma.asegurada4.ajustado <- suma.asegurada4 * ((1.03)^(i-1))
    suma.asegurada5.ajustado <- suma.asegurada5 * ((1.03)^(i-1))
    suma.asegurada6.ajustado <- suma.asegurada6 * ((1.03)^(i-1))
    
    #ESTADO 1
    #-Ingresos por primas:
    
    #Obtenemos edades de la gente en estado 1 al principio del año i (o sea al final de i-1)
    #Para esto obtenemos los índices de las personas que estaban en estado uno. Usamos esos índices para obtener su respectiva edad
    edades1.principio.año <- edades[info.año.i.anterior$indices[[1]]]
    
    contar.edades.principio <- contar.18.64(edades1.principio.año)
    
    #Esta gente paga prima, entonces los ingresos son la prima
    #Hay que considerar que solo pagan primas hasta 65 años (no incluido). 
    if((65-i-17) >= 1){
       ingresos.por.estado[i,1] <- 
      sum((contar.edades.principio * primas.por.edad.ajustado)[1:(65-i-17)])
       #-EGRESOS:
      egresos.por.estado[i,1] <- 0.10 *  ingresos.por.estado[i,1]
    }
    
    #ESTADO 2:
    #-Ingresos por primas:
    
    #Obtenemos edades de la gente en estado 2 al principio del año i (o sea al final de i-1)
    edades2.principio.año <- edades[info.año.i.anterior$indices[[2]]] 
    
    contar.edades.principio <- contar.18.64(edades2.principio.año)
    
    #Esta gente paga prima, entonces los ingresos son la prima
    #Hay que considerar que solo pagan primas hasta 65 años (no incluido). 
    if((65-i-17) >= 1){
       ingresos.por.estado[i,2] <- 
      sum((contar.edades.principio * primas.por.edad.ajustado)[1:(65-i-17)])
       
       #-EGRESOS:
      egresos.por.estado[i,2] <- 0.10 *  ingresos.por.estado[i,2]
    }
    
    #ESTADO 3
    #Esta gente no paga prima ni recibe beneficios entonces no hay ni ingresos ni egresos
    
    #ESTADO 4
    
    #No hay ingresos
    
    #-Egresos: 
    #No es necesario contar edades porque el egreso es el mismo para todos.
    egresos.por.estado[i,4] <- 
      info.año.i.anterior$conteos[4]*suma.asegurada4.ajustado
    
    #ESTADO 5
    
    #No hay ingresos
    
    #-Egresos: 
    #No es necesario contar edades porque el egreso es el mismo para todos.
    egresos.por.estado[i,5] <-  
      info.año.i.anterior$conteos[5]*suma.asegurada5.ajustado
    
    #ESTADO 6
    
    #No hay ingresos
    
    #-Egresos: 
    #Egresos de muertos del año pasado
    egresos.por.estado[i,6] <- 
      info.año.i.anterior$conteos[6]*suma.asegurada6.ajustado
    
    #si ya todos se murieron detenemos el ciclo for
    if(cant.por.estado[i,6] == length(edades)){
      break
    }
  }
  
  cant.por.estado[, 6] <- cumsum(cant.por.estado[, 6])
  ingresos <- as.list(rowSums(ingresos.por.estado))
  egresos <- as.list(rowSums(egresos.por.estado))
  
  return(list(estados = cant.por.estado, 
              ingresos = ingresos, 
              egresos = egresos,
              ingresos.estado = ingresos.por.estado,
              egresos.estado = egresos.por.estado)
         )
}

```

## Simulación
```{r}
#Generemos 5000 pólizas al azar, según sexo y edad.
set.seed(123)
#genero aleatorio (0 = hombre, 1 = mujer)
genero <- sample(c(0, 1), 5000, replace = TRUE)
edades <- sample(18:64, 5000, replace = TRUE)

polizas <- data.frame(edades= edades, genero= genero) 
hombres <- polizas[polizas$genero == 0, ]
mujeres <- polizas[polizas$genero == 1, ]
```

## Resultados
```{r}
cant.simulaciones <- 5000
suma.asegurada4 <- 10850000
suma.asegurada5 <- 16570000
suma.asegurada6 <- 1150000

simulaciones.h <- list()
simulaciones.m <- list()

for (i in 1:cant.simulaciones){
  simulaciones.h[[i]] <- simulacion.hombres(hombres, primas.hombres, suma.asegurada4, suma.asegurada5, suma.asegurada6)
  simulaciones.m[[i]] <- simulacion.mujeres(mujeres, primas.mujeres, suma.asegurada4, suma.asegurada5, suma.asegurada6)
}
```

```{r}
#Calculamos la esperanza de los estados, por género. 
suma.matrices.h <- matrix(0, nrow = 103, ncol = 6)
suma.matrices.m <- matrix(0, nrow = 103, ncol = 6)

for (i in 1:cant.simulaciones){
  suma.matrices.h <- suma.matrices.h + simulaciones.h[[i]]$estados
  suma.matrices.m <- suma.matrices.m + simulaciones.m[[i]]$estados
}
esperanza.estados.h <- suma.matrices.h / cant.simulaciones
esperanza.estados.m <- suma.matrices.m / cant.simulaciones

```

```{r}
#Calculamos la esperanza de las pérdidas futuras, por género.
perdidas.futuras.m <- list()
perdidas.futuras.h <- list()

for (i in 1:cant.simulaciones){
  ingresos.m <- as.numeric(simulaciones.m[[i]]$ingresos)
  egresos.m <- as.numeric(simulaciones.m[[i]]$egresos)
  
  ingresos.h <- as.numeric(simulaciones.h[[i]]$ingresos)
  egresos.h <- as.numeric(simulaciones.h[[i]]$egresos)
  
  # Calcular el valor presente de ingresos y egresos
  años <- 0:102  # Años correspondientes a los flujos

  # Calcular los valores presentes
  vp_ingresos.m <- ingresos.m / (1 + c(0, interes))[años + 1]^años
  vp_egresos.m <- egresos.m / (1 + c(0, interes))[años + 1]^años
  
  vp_ingresos.h <- ingresos.h / (1 + c(0, interes))[años + 1]^años
  vp_egresos.h <- egresos.h / (1 + c(0, interes))[años + 1]^años
  
  # Diferencia entre ingresos y egresos
  vp_diferencia.m <- vp_egresos.m - vp_ingresos.m
  vp_diferencia.h <- vp_egresos.h - vp_ingresos.h

  # Suma total de la diferencia
  perdidas.futuras.m[[i]] <- sum(vp_diferencia.m)
  perdidas.futuras.h[[i]] <- sum(vp_diferencia.h)
}
esperanza.perdidas.m <- mean(unlist(perdidas.futuras.m))
esperanza.perdidas.h <- mean(unlist(perdidas.futuras.h))

cat('Valor presente de pérdida futura hombres (en miles de millones): \n')
cat(esperanza.perdidas.h /1000000000)
cat('\n')

cat('Valor presente de pérdida futura mujeres (en miles de millones): \n')
cat(esperanza.perdidas.m /1000000000)
```

# Graficos 

```{r}
library(ggplot2)

# Gráfico de distribución de edades
ggplot(polizas, aes(x = edades)) +
  geom_histogram(binwidth = 3, fill = "seagreen", color = "black") +
  labs(x = "Edad",  y = "Cantidad", 
       title = "Distribución de Edades", 
       caption = "Fuente: elaboración propia") +
  theme_minimal()

```

```{r}
# creamos una nueva columna donde se convitio (0,1) en (hombres,mujeres)
polizas$genero.factor <- factor(polizas$genero, levels = c(0, 1), labels = c("Hombre", "Mujer"))

# Creaamos un grafico de barras para ver la distribucion por cada genero
ggplot(polizas, aes(x = genero.factor, fill = genero.factor)) +
  geom_bar() +
  labs(x = "Género", y = "Cantidad", 
       title = "Distribución de Géneros", 
       caption = "Fuente: elaboración propia") +
  scale_fill_manual(name = "Género", 
                    values = c("cornflowerblue", "lightcoral")) +
  theme_minimal()

```

```{r}
# realizamos un grafico de densidad con transparencia por edades
ggplot(polizas, aes(x = edades, fill = as.factor(genero))) +
  geom_density(alpha = 0.5) + 
  labs(x = "Edad", y = "Densidad", 
       title = "Distribución de Edades por Género", 
       caption = "Fuente: elaboración propia") +
  scale_fill_manual(name = "Género", values = c("#009ACD", "#FF3030"),
                    labels = c("Hombre", "Mujer")) +
  theme_minimal()

```


```{r}
# realizamos u grafico con trasnparencia por edades
ggplot(polizas, aes(x = edades, fill = as.factor(genero))) +
  geom_histogram(binwidth = 5, color = "black", position = "identity", alpha = 0.5) +
  labs(x = "Edad", 
       y = "Cantidad", 
       title = "Distribución de Edades por Género", 
       caption = "Fuente: elaboración propia") +
  scale_fill_manual(name = "Género", 
                    values = c("#009ACD", "#FF3030"),
                    labels = c("Hombre", "Mujer")) +
  theme_minimal()

```


```{r}
# partimos en intervalos de 5 en 5
polizas$edad.grupo <- cut(polizas$edades, breaks = seq(18, 68, by = 5), right = FALSE)

# Realiamos un grafico de barras apiladas donde se muestra la proporcion de cada genero
ggplot(polizas, aes(x = edad.grupo, fill = as.factor(genero))) +
  geom_bar(position = "fill") +
  labs(x = "Grupo de Edad", 
       y = "Proporción", 
       title = "Proporción de Géneros por Grupo de Edad", 
       caption = "Fuente: elaboración propia") +
  scale_fill_manual(name = "Género", 
                    values = c("limegreen", "lightcoral"),
                    labels = c("Hombre", "Mujer")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

```{r}
# 
# Boxplot de edades por género
ggplot(polizas, aes(x = as.factor(genero), y = edades, fill = as.factor(genero))) +
  geom_boxplot(outlier.color = "red", outlier.shape = 16) +
  labs(x = "Género", 
       y = "Edad", 
       title = "Distribución de Edades por Género (Boxplot)", 
       caption = "Fuente: elaboración propia") +
  scale_fill_manual(name = "Género", 
                    values = c("green3", "coral2"),
                    labels = c("Hombre", "Mujer")) +
  theme_minimal()

```










